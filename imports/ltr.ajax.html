<html>
  <head>
    <title>ltg - AJAX Library</title>
    <link rel="import" href="ltr.remote.html">
    <link rel="import" href="ltr.ajax.service.html">
    <style type="text/css">
      ltr-ajax header, ajax-get header, ajax-post header { display: none; }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      (function() {
        ltg.element('ltrAjax', ['ltgRemote'], ['$ajax', function($ajax) {
          this.noShadow = true;

          this.controller(function($element, $attrs) {    
            this.request = function(url, settings) {
              //TODO: Setup the headers
              if(!settings) { settings = {}; }
              if(!settings.headers) { settings.headers = {}; }
              D.forEach( D.findAll($element, ':scope > header'),
                function(header) {
                  settings.headers[D.attr(header, 'name')] =
                    D.attr(header, 'value') || header.innerText;
                }
              );

              return $ajax.request(url, settings);
            };
            
            this.credentials = function() {};
          }, true);
        }]);
      })()
    </script>
    <script>
      (function() {
        ltg.element('ajaxRequest', ['ltgRequest'], function() {
          this.noShadow = true;
          this.bindings = {
            '*': 'url',
            '=': 'promise'
          };

          this.controller(function($element, $attrs) {
            this.build = function() {
              var method = $attrs.$get('method') || $element.tagName.split('-')[1] || 'GET',
              settings = {
                type: method,
                headers: {},
                data: {}
              }, form;

              D.forEach( D.findAll($element, ':scope > header'),
                function(header) {
                  settings.headers[D.attr(header, 'name')] =
                    D.attr(header, 'value') || header.innerText;
                }
              );

              D.forEach( D.findAll($element, ':scope > data'),
                function(data) {
                  settings.data[D.attr(data, 'name')] =
                    D.attr(data, 'value') || data.innerText;
                }
              );

              if( (form  = D.find($element, $attrs.form || 'from')) ) {
                D.forEach(form.elements,
                  function(input) {
                    if(input.name) { settings.data[input.name] = input; }
                  }
                );
              }

              return settings;
            };
          });

          this.link(function(element, attrs, ctrls) {
            attrs.$observer('send', function(value) {
              if(value === 'true' && ctrls.ltrAjax.request) {
                //TODO: Need to register events
                element.promise = ctrls.ltrAjax.request(element.url, 
                  ctrls.ajaxRequest.build()).then(
                    function(data) {
                      attrs.$set('send', false);
                      element.data = data;
                    });
                attrs.$dispatch('request', { bubbles: true, 
                  cancelable: true,
                  detail: element.promise });
              }
            });
          }, ['^ltrAjax']);
        });
      })();
    </script>
    <script>
      (function() {
        ltg.element('ajaxGet', ['ajaxRequest'], function() {
          this.noShadow = true;
        });
      })();
    </script>
    <script>
      (function() {
        ltg.element('ajaxPost', ['ajaxRequest'], function() {
          this.noShadow = true;
        });
      })();
    </script>
  </body>
</html>